<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理员后台 | 英语单词网站</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "微软雅黑"; }
    .container { max-width: 1000px; margin: 50px auto; padding: 20px; }
    h2 { color: #3498db; margin-bottom: 20px; text-align: center; }
    .login-box { text-align: center; margin-bottom: 30px; }
    #adminPwd { padding: 10px; width: 200px; border: 1px solid #ddd; border-radius: 6px; }
    #loginBtn { padding: 10px 25px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px; }
    #loginBtn:hover { background: #2980b9; }

    /* 新增：统计面板样式 */
    .stats-panel {
      display: none;
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #eee;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    .stats-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stats-card h3 {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .stats-card .num {
      font-size: 24px;
      font-weight: bold;
      color: #3498db;
    }
    .daily-chart {
      margin-top: 20px;
    }
    .daily-chart h4 {
      color: #333;
      margin-bottom: 10px;
    }
    .daily-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    /* 原有表格样式 */
    table { width: 100%; border-collapse: collapse; display: none; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background: #f5f5f5; color: #333; }
    tr:nth-child(even) { background: #f9f9f9; }
  </style>
</head>
<body>
  <div class="container">
    <h2>访客单词需求管理后台</h2>
    <div class="login-box">
      <input type="password" id="adminPwd" placeholder="输入管理员密码">
      <button id="loginBtn" onclick="login()">登录查看</button>
    </div>

    <!-- 新增：统计面板 -->
    <div class="stats-panel" id="statsPanel">
      <h3>数据统计</h3>
      <div class="stats-grid">
        <div class="stats-card">
          <h3>总提交量</h3>
          <div class="num" id="totalCount">0</div>
        </div>
        <div class="stats-card">
          <h3>今日提交量</h3>
          <div class="num" id="todayCount">0</div>
        </div>
        <div class="stats-card">
          <h3>本周提交量</h3>
          <div class="num" id="weekCount">0</div>
        </div>
      </div>
      <div class="daily-chart">
        <h4>近7天提交明细</h4>
        <div id="dailyList"></div>
      </div>
    </div>

    <!-- 原有数据表格 -->
    <table id="dataTable">
      <tr><th>ID</th><th>想学习的单词</th><th>访客IP</th><th>提交时间</th></tr>
      <tbody id="requestList"></tbody>
    </table>
  </div>

  <script>
    let password = ''; // 存储登录密码，避免重复输入

    // 登录函数（整合统计+数据查询）
    async function login() {
      password = document.getElementById('adminPwd').value;
      if (!password) {
        alert('请输入管理员密码！');
        return;
      }
      
      // 先获取统计数据
      await getStats();
      // 再获取所有提交数据
      await getRequests();
    }

    // 新增：获取统计数据
    async function getStats() {
      try {
        const res = await fetch(`https://word-submit.feiyuan896.workers.dev/get-stats?password=${encodeURIComponent(password)}`);
        if (res.status === 403) {
          alert('密码错误！');
          return;
        }
        const data = await res.json();
        
        // 显示统计面板
        document.getElementById('statsPanel').style.display = 'block';
        // 更新统计数字
        document.getElementById('totalCount').textContent = data.total;
        document.getElementById('todayCount').textContent = data.today;
        document.getElementById('weekCount').textContent = data.week;

        // 渲染近7天明细
        const dailyList = document.getElementById('dailyList');
        dailyList.innerHTML = '';
        if (data.daily.length === 0) {
          dailyList.innerHTML = '<div>暂无数据</div>';
          return;
        }
        data.daily.forEach(item => {
          const div = document.createElement('div');
          div.className = 'daily-item';
          div.innerHTML = `
            <span>${item.date_str}</span>
            <span>${item.count} 次</span>
          `;
          dailyList.appendChild(div);
        });
      } catch (err) {
        alert('获取统计数据失败！');
        console.log(err);
      }
    }

    // 原有：获取所有提交数据
    async function getRequests() {
      try {
        const res = await fetch(`https://word-submit.feiyuan896.workers.dev/get-requests?password=${encodeURIComponent(password)}`);
        const data = await res.json();
        
        document.getElementById('dataTable').style.display = 'block';
        const list = document.getElementById('requestList');
        list.innerHTML = '';
        if (data.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="4">暂无访客提交的需求</td>';
          list.appendChild(tr);
          return;
        }
        data.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.id}</td>
            <td>${item.word}</td>
            <td>${item.ip}</td>
            <td>${item.create_time}</td>
          `;
          list.appendChild(tr);
        });
      } catch (err) {
        alert('获取提交数据失败，请稍后再试！');
        console.log(err);
      }
    }
  </script>
</body>
</html>
